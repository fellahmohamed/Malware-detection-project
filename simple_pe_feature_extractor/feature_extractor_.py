import pefile
import json

def get_pe_info(pe, conf):
    # Extract header fields
    header_info = {}
    for field in conf["header_fields"]:
        if hasattr(pe.FILE_HEADER, field):
            header_info[field] = getattr(pe.FILE_HEADER, field)

    # Extract information about sections
    sections_info = []
    for section in pe.sections:
        section_info = {}
        for field in conf["section_fields"]:
            if hasattr(section, field):
                # Decode 'Name' from bytes to string
                if field == "Name":
                    section_info[field] = section.Name.decode().strip('\x00')
                else:
                    section_info[field] = getattr(section, field)
        sections_info.append(section_info)

    # Check presence of imported DLLs
    imported_dlls = {entry.dll.decode(): 1 for entry in pe.DIRECTORY_ENTRY_IMPORT}
    dlls_info = {dll: imported_dlls.get(dll, 0) for dll in conf["dlls"]}

    # Check presence of API functions
    apis_info = {}
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        for imp in entry.imports:
            api_name = imp.name.decode() if imp.name else ""
            if api_name in conf["api_functions"]:
                apis_info[api_name] = 1

    return {"Header": header_info, "Sections": sections_info, "ImportedDLLs": dlls_info, "ImportedAPIs": apis_info}

def main():
    pe_file_path = "example.exe"  # Path to your PE file

    with open("conf.json", "r") as conf_file:
        conf = json.load(conf_file)

    pe = pefile.PE(pe_file_path)
    pe_info = get_pe_info(pe, conf)

    with open("example.json", "w") as json_file:
        json.dump(pe_info, json_file, indent=4)

if __name__ == "__main__":
    main()

